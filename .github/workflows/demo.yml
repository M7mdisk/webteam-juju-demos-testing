name: Demo
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
permissions:
  pull-requests: write
  packages: write

# Ensure only one demo runs at a time.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: Setup Demo
    runs-on: ubuntu-latest
    outputs:
      demo-id: ${{ steps.demo-id.outputs.id }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get demo ID
        id: demo-id
        run: |
          echo "id=${{ github.event.repository.name }}-pr${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

  comment-pending:
    name: Comment (Pending)
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Post pending comment
        uses: ./.github/actions/demo-comment
        with:
          demo-id: ${{ needs.setup.outputs.demo-id }}
          status: pending
          run-id: ${{ github.run_id }}

  build-rock:
    name: Build Rock
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup LXD
        uses: canonical/setup-lxd@main
      
      - name: Setup rockcraft
        run: sudo snap install rockcraft --classic
      
      - name: Cache rock
        id: cache-rock
        uses: actions/cache@v4
        with:
          path: "*.rock"
          key: rock-${{ hashFiles('rockcraft.yaml', 'app.py', 'requirements.txt') }}
      
      - name: Pack rock
        if: steps.cache-rock.outputs.cache-hit != 'true'
        run: rockcraft pack
      
      - name: Upload rock artifact
        uses: actions/upload-artifact@v6
        with:
          name: rock-${{ needs.setup.outputs.demo-id }}
          path: "*.rock"
          retention-days: 1

  build-charm:
    name: Build Charm
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup LXD
        uses: canonical/setup-lxd@main
      
      - name: Setup charmcraft
        run: sudo snap install charmcraft --classic --channel=latest/stable
      
      - name: Cache charm
        id: cache-charm
        uses: actions/cache@v4
        with:
          path: "charm/*.charm"
          key: charm-${{ hashFiles('charm/**') }}
      
      - name: Pack charm
        if: steps.cache-charm.outputs.cache-hit != 'true'
        run: |
          cd charm
          charmcraft pack -v
      
      - name: Upload charm artifact
        uses: actions/upload-artifact@v6
        with:
          name: charm-${{ needs.setup.outputs.demo-id }}
          path: "charm/*.charm"
          retention-days: 1

  deploy:
    name: Deploy to Juju
    needs: [setup, build-rock, build-charm]
    runs-on: ubuntu-latest
    env:
      DEMOS_JUJU_CLIENT_ID: ${{ secrets.DEMOS_JUJU_CLIENT_ID }}
      DEMOS_JUJU_CLIENT_SECRET: ${{ secrets.DEMOS_JUJU_CLIENT_SECRET }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download rock
        uses: actions/download-artifact@v6
        with:
          name: rock-${{ needs.setup.outputs.demo-id }}
      
      - name: Download charm
        uses: actions/download-artifact@v6
        with:
          name: charm-${{ needs.setup.outputs.demo-id }}
      
      - name: Set image URL
        id: image-url
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "url=ghcr.io/${REPO_LOWER}:${{ needs.setup.outputs.demo-id }}" >> $GITHUB_OUTPUT
      
      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      
      - name: Push rock to GHCR
        run: |
          ROCK_FILE=$(ls *.rock)
          skopeo --insecure-policy copy oci-archive:$ROCK_FILE docker://${{ steps.image-url.outputs.url }} --dest-creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}"
      
      - name: Install Juju
        run: sudo snap install juju
      
      - name: Authenticate with JAAS
        env:
          JUJU_CLIENT_ID: ${{ secrets.DEMOS_JUJU_CLIENT_ID }}
          JUJU_CLIENT_SECRET: ${{ secrets.DEMOS_JUJU_CLIENT_SECRET }}
        run: juju login jaas.ps7.canonical.com:443/k8s-jaas-ps7-jimm-jimm -c jaas-ps7
      
      - name: Deploy charm
        env:
          JUJU_CLIENT_ID: ${{ secrets.DEMOS_JUJU_CLIENT_ID }}
          JUJU_CLIENT_SECRET: ${{ secrets.DEMOS_JUJU_CLIENT_SECRET }}
        run: |
          CHARM_FILE=$(ls *.charm)
          juju deploy "./$CHARM_FILE" ${{ needs.setup.outputs.demo-id }} \
            --resource flask-app-image=${{ steps.image-url.outputs.url }} \
            -m 795798e4-922f-49c7-9169-004ffc17df90@serviceaccount/k8s-webteam-demos-default

      - uses: hashicorp/setup-terraform@v3

      - name: Write Terraform base config
        run: |
          cat > terraform/demo/_base.tf << 'EOF'
          terraform {
            required_providers {
              juju = {
                source  = "juju/juju"
                version = "~> 1.1.0"
              }
            }
          }

          # Credentials via JUJU_CLIENT_ID and JUJU_CLIENT_SECRET environment variables.
          provider "juju" {
            controller_addresses = "jaas.ps7.canonical.com:443/k8s-jaas-ps7-jimm-jimm"
          }

          data "juju_model" "demos" {
            owner = "795798e4-922f-49c7-9169-004ffc17df90@serviceaccount"
            name  = "k8s-webteam-demos-default"
          }

          variable "demo_id" {
            description = "Unique identifier for this demo (e.g. my-repo-pr42)."
            type        = string
          }
          EOF

      - name: Terraform init
        run: terraform -chdir=terraform/demo init

      - name: Run Juju imports
        if: hashFiles('terraform/demo/juju_imports.sh') != ''
        env:
          JUJU_CLIENT_ID: ${{ secrets.DEMOS_JUJU_CLIENT_ID }}
          JUJU_CLIENT_SECRET: ${{ secrets.DEMOS_JUJU_CLIENT_SECRET }}
          TF_VAR_demo_id: ${{ needs.setup.outputs.demo-id }}
          DEMO_ID: ${{ needs.setup.outputs.demo-id }}
          MODEL_UUID: "40cad239-1fe9-497f-89a2-ce70ab3e33af"
        run: bash terraform/demo/juju_imports.sh

      - name: Terraform apply
        env:
          JUJU_CLIENT_ID: ${{ secrets.DEMOS_JUJU_CLIENT_ID }}
          JUJU_CLIENT_SECRET: ${{ secrets.DEMOS_JUJU_CLIENT_SECRET }}
          TF_VAR_demo_id: ${{ needs.setup.outputs.demo-id }}
        run: terraform -chdir=terraform/demo apply -auto-approve

      - name: Upload Terraform state
        uses: actions/upload-artifact@v6
        with:
          name: tfstate-${{ needs.setup.outputs.demo-id }}
          path: terraform/demo/terraform.tfstate
          retention-days: 90
      
      - name: Post demo comment
        uses: ./.github/actions/demo-comment
        with:
          demo-id: ${{ needs.setup.outputs.demo-id }}
          status: deployed
